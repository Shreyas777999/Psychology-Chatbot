<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychology Insights Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap');
        :root{--primary-blue:#2c3e50;--light-blue:#ecf0f1;--accent-green:#27ae60;--text-dark:#34495e;--text-light:#fdfefe;--bubble-user:#e8f6f3;--bubble-bot:#dbeaf5;--system-info:#f0f4f7;--border-light:#bdc3c7;--shadow-light:rgba(0,0,0,0.08);--shadow-medium:rgba(0,0,0,0.15);}
        body{font-family:'Poppins',sans-serif;margin:0;padding:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background-color:var(--light-blue);overflow:hidden;color:var(--text-dark);}
        .full-page-container{width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;padding:1.5rem;box-sizing:border-box;}
        .chat-container{background-color:#FFFFFF;border-radius:1.5rem;box-shadow:0 25px 50px var(--shadow-medium);overflow:hidden;display:flex;flex-direction:column;width:100%;height:100%;max-width:960px;max-height:800px;transition:all 0.3s ease-out;}
        @media (max-width:768px){.chat-container{max-width:95vw;max-height:90vh;}}
        .header-bg{background:linear-gradient(135deg,var(--primary-blue) 0%,#3498db 100%);color:var(--text-light);padding:1.5rem 2rem;display:flex;align-items:center;justify-content:center;position:relative;border-top-left-radius:1.5rem;border-top-right-radius:1.5rem;box-shadow:0 2px 8px var(--shadow-light);z-index:10;}
        .header-content{display:flex;align-items:center;gap:1.2rem;animation:fadeInDown 0.8s ease-out;}
        .logo-symbol{height:50px;width:50px;border-radius:50%;box-shadow:0 3px 10px var(--shadow-medium);object-fit:cover;background-color:white;}
        .header-title{font-family:'Lora',serif;font-size:1.8rem;font-weight:700;letter-spacing:-0.03em;text-shadow:1px 1px 3px rgba(0,0,0,0.2);}
        .header-subtitle{font-family:'Poppins',sans-serif;font-size:0.95rem;opacity:0.9;}
        .logo-welcome-subtle{height:100px;width:100px;opacity:0.4;margin-bottom:1.5rem;object-fit:contain;}
        .chat-message-user{background-color:var(--bubble-user);color:var(--text-dark);border-radius:1rem;border-bottom-right-radius:0.5rem;box-shadow:0 1px 3px var(--shadow-light);}
        .chat-message-bot{background-color:var(--bubble-bot);color:var(--text-dark);border-radius:1rem;border-bottom-left-radius:0.5rem;box-shadow:0 1px 3px var(--shadow-light);}
        .chat-message-system-thought{background-color:var(--system-info);color:var(--text-dark);font-size:0.85rem;font-style:italic;border-radius:0.75rem;border-left:5px solid var(--border-light);padding-left:1.2rem;box-shadow:0 1px 2px rgba(0,0,0,0.03);}
        .chat-message-bot p,.chat-message-user p,.chat-message-system-thought p{margin-bottom:0.5em;line-height:1.6;white-space:pre-wrap;}
        .chat-message-bot p:last-child,.chat-message-user p:last-child,.chat-message-system-thought p:last-child{margin-bottom:0;}
        .input-field{border:1px solid var(--border-light);border-radius:9999px;padding:0.8rem 1.6rem;transition:border-color 0.2s ease-in-out,box-shadow 0.2s ease-in-out;box-shadow:inset 0 1px 2px rgba(0,0,0,0.04);font-size:1rem;color:var(--text-dark);}
        .input-field:focus{outline:none;border-color:var(--accent-green);box-shadow:0 0 0 3px rgba(39,174,96,0.2);}
        .send-button{background-color:var(--accent-green);border-radius:9999px;width:60px;height:48px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px var(--shadow-light);transition:background-color 0.3s ease,transform 0.2s ease;flex-shrink:0;}
        .send-button:hover{background-color:#2ecc71;transform:scale(1.05);box-shadow:0 3px 8px var(--shadow-medium);}
        .feature-button{font-weight:500;padding:0.7rem 1.4rem;border-radius:9999px;box-shadow:0 2px 5px var(--shadow-light);transition:all 0.2s ease-in-out;color:var(--text-light);display:flex;align-items:center;gap:0.6rem;font-size:0.9rem;}
        .feature-button:hover{transform:translateY(-1px);box-shadow:0 3px 7px var(--shadow-medium);}
        .dot-pulse{display:flex;align-items:center;justify-content:center;}
        .dot-pulse-dot{width:8px;height:8px;background-color:var(--primary-blue);border-radius:50%;margin:0 4px;animation:dotPulse 1.2s infinite ease-in-out;}
        .dot-pulse-dot:nth-child(1){animation-delay:0s;}
        .dot-pulse-dot:nth-child(2){animation-delay:0.15s;}
        .dot-pulse-dot:nth-child(3){animation-delay:0.3s;}
        @keyframes dotPulse{0%,100%{transform:scale(0.7);opacity:0.7;}50%{transform:scale(1);opacity:1;}}
        @keyframes fadeInDown{from{opacity:0;transform:translateY(-15px);}to{opacity:1;transform:translateY(0);}}
        @keyframes fadeInUp{from{opacity:0;transform:translateY(15px);}to{opacity:1;transform:translateY(0);}}
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        document.addEventListener('DOMContentLoaded', () => {
            const { useState, useEffect, useRef } = React;
            const { createRoot } = ReactDOM;
            const marked = window.marked;

            // ===========================================================================================
            // !!! ----------------------------- IMPORTANT API KEY CONFIGURATION ----------------------- !!!
            //                                                                                           #
            //   1. Replace "YOUR_GEMINI_API_KEY_HERE" with your actual Gemini API key.                  #
            //   2. Get your key from: https://aistudio.google.com/app/apikey                            #
            //                                                                                           #
            //   SECURITY WARNING: This method is for LOCAL TESTING ONLY.                                #
            //   If you upload this file to a public website (like GitHub Pages), your key will be       #
            //   exposed and can be stolen. For a live site, you must use a backend server.              #
            //                                                                                           #
            // ===========================================================================================
            const API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // <-- REPLACE WITH YOUR REAL KEY
            const MODEL_NAME = "gemini-1.5-flash";
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;


            const App = () => {
                const [messages, setMessages] = useState([]);
                const [inputValue, setInputValue] = useState('');
                const [isLoading, setIsLoading] = useState(false);
                const [isAnalyzing, setIsAnalyzing] = useState(false);
                const [isSuggesting, setIsSuggesting] = useState(false);
                const messagesEndRef = useRef(null);

                useEffect(() => {
                    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                }, [messages]);

                // Helper function to call the Gemini API directly
                const callApi = async (prompt) => {
                    try {
                        const response = await fetch(GEMINI_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                        });

                        if (!response.ok) {
                            const errorResult = await response.json();
                            console.error("Gemini API Error:", errorResult);
                            return `Error: ${errorResult.error?.message || 'Failed to get a valid response from the API.'}`;
                        }

                        const result = await response.json();
                        return result?.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I couldn't process that response.";

                    } catch (error) {
                        console.error(`Network or fetch error: ${error}`);
                        return "I'm having trouble connecting. Please check your network connection and API key.";
                    }
                };

                const generateOptimizedPsychPrompt = async (userInput) => {
                    const simpleGreetings = ["hi", "hello", "hey", "good morning", "good afternoon", "good evening"];
                    if (userInput.split(' ').length <= 3 && simpleGreetings.includes(userInput.toLowerCase().trim())) {
                        return "SIMPLE_GREETING";
                    }
                    const promptForDirection = `You are an expert prompt engineer for a psychology chatbot. Convert the user's input into a refined, insightful, and precise psychological "direction". This direction should distill the core psychological essence and potential underlying issues. If the input is vague, provide a direction that encourages clarifying questions.
                    **User Input:** "${userInput}"
                    **Final Direction:**`;
                    return callApi(promptForDirection);
                };

                const getPsychBotResponse = async (optimizedPrompt) => {
                    if (optimizedPrompt === "SIMPLE_GREETING") {
                        return "Hello! It's good to connect with you. How are you feeling today, or what's on your mind? I'm here to listen.";
                    }
                    const isInitialAssessmentNeeded = optimizedPrompt.startsWith("INITIAL_ASSESSMENT_NEEDED:");
                    let finalPrompt;
                    if (isInitialAssessmentNeeded) {
                        const coreDirection = optimizedPrompt.substring("INITIAL_ASSESSMENT_NEEDED:".length).trim();
                        finalPrompt = `You are an expert, empathetic therapist. The user needs an initial assessment based on: "${coreDirection}". Your response must:
                        1.  Start with empathy and validation.
                        2.  Briefly explain potential psychological underpinnings of their symptoms.
                        3.  Ask thoughtful, open-ended probing questions to guide the user.
                        4.  Use clear, natural paragraphs and markdown for emphasis.`;
                    } else {
                        finalPrompt = `You are an expert, empathetic therapist providing psychoanalysis based on the focus: "${optimizedPrompt}". Your response must:
                        1.  Use a compassionate, understanding, and gently challenging tone.
                        2.  Offer sharp insights into deeper psychological principles (cognitive distortions, attachment theory, etc.) without complex jargon.
                        3.  Provide actionable self-reflection prompts.
                        4.  Maintain a conversational flow with clear paragraphs.`;
                    }
                    return callApi(finalPrompt);
                };

                const handleSendMessage = async (e) => {
                    e.preventDefault();
                    const userQuery = inputValue.trim();
                    if (!userQuery) return;

                    setMessages(prev => [...prev, { text: userQuery, sender: 'user' }]);
                    setInputValue('');
                    setIsLoading(true);

                    try {
                        const optimizedPromptDirection = await generateOptimizedPsychPrompt(userQuery);
                        if (!optimizedPromptDirection.startsWith("Error:") && !optimizedPromptDirection.startsWith("I'm having trouble")) {
                             if (optimizedPromptDirection !== "SIMPLE_GREETING") {
                                setMessages(prev => [...prev, { text: `**System Thought:** Focusing on: "${optimizedPromptDirection}"`, sender: 'system-thought' }]);
                             }
                             const botResponse = await getPsychBotResponse(optimizedPromptDirection);
                             setMessages(prev => [...prev, { text: botResponse, sender: 'bot' }]);
                        } else {
                            setMessages(prev => [...prev, { text: optimizedPromptDirection, sender: 'bot' }]);
                        }
                    } catch (error) {
                        console.error("Error processing message:", error);
                        setMessages(prev => [...prev, { text: "Oops! Something went wrong. Please try again.", sender: 'bot' }]);
                    } finally {
                        setIsLoading(false);
                    }
                };

                const analyzeLastMessageSentiment = async () => {
                    const lastUserMessage = messages.slice().reverse().find(msg => msg.sender === 'user');
                    if (!lastUserMessage) return;
                    setIsAnalyzing(true);
                    const prompt = `Analyze the primary and underlying emotions in the following text. Consider potential psychological "blind spots". Provide a concise description and an empathetic insight. Start with "**Emotion & Insight:**".
                    **Text:** "${lastUserMessage.text}"`;
                    
                    const analysis = await callApi(prompt);
                    setMessages(prev => [...prev, { text: `âœ¨ ${analysis}`, sender: 'bot' }]);
                    setIsAnalyzing(false);
                };

                const suggestCopingStrategy = async () => {
                    const lastUserMessage = messages.slice().reverse().find(msg => msg.sender === 'user');
                    if (!lastUserMessage) return;
                    setIsSuggesting(true);
                    const prompt = `Based on the user statement, suggest a simple, evidence-based psychological coping strategy or self-care tip. Make it actionable and encouraging. Start with "**Coping Tip & Self-Observation:**".
                    **User Statement:** "${lastUserMessage.text}"`;
                    
                    const strategy = await callApi(prompt);
                    setMessages(prev => [...prev, { text: `ðŸŒ± ${strategy}`, sender: 'bot' }]);
                    setIsSuggesting(false);
                };

                return (
                    <div className="full-page-container">
                        <div className="chat-container">
                             <div className="header-bg">
                                <div className="header-content">
                                    <img src="logo.png" alt="Logo" className="logo-symbol"/>
                                    <div>
                                        <h1 className="header-title">Psychology Insights</h1>
                                        <p className="header-subtitle">Your AI Companion for Well-being</p>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 p-4 sm:p-6 overflow-y-auto flex flex-col gap-3">
                                {messages.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center h-full text-gray-500 text-center p-4">
                                        <img src="logo.png" alt="Logo" className="logo-welcome-subtle"/>
                                        <p className="text-xl font-medium font-lora text-gray-700">Explore your mind with AI.</p>
                                        <p className="text-md mt-2 font-poppins text-gray-600">Ask about theories, analyze feelings, or discover coping strategies.</p>
                                    </div>
                                ) : (
                                    messages.map((msg, index) => (
                                        <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[75%] px-4 py-3 text-wrap break-words ${msg.sender === 'user' ? 'chat-message-user' : msg.sender === 'bot' ? 'chat-message-bot' : 'chat-message-system-thought'}`}>
                                                <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.text) }}></div>
                                            </div>
                                        </div>
                                    ))
                                )}
                                {(isLoading || isAnalyzing || isSuggesting) && (
                                    <div className="flex justify-start">
                                        <div className="max-w-[80%] px-4 py-2 rounded-xl">
                                            <div className="dot-pulse"><div className="dot-pulse-dot"></div><div className="dot-pulse-dot"></div><div className="dot-pulse-dot"></div></div>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef}></div>
                            </div>
                            
                            <form onSubmit={handleSendMessage} className="p-4 sm:p-5 bg-white border-t border-gray-100 flex items-center gap-3">
                                <div className="flex-1">
                                    <input type="text" value={inputValue} onChange={e => setInputValue(e.target.value)} placeholder="Type your thoughts here..." className="input-field w-full" disabled={isLoading || isAnalyzing || isSuggesting}/>
                                </div>
                                <button type="submit" className="send-button text-white" disabled={isLoading || isAnalyzing || isSuggesting || !inputValue.trim()}>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" /></svg>
                                </button>
                            </form>
                            
                            <div className="p-4 sm:p-5 bg-gray-50 border-t border-gray-100 flex justify-center gap-4 flex-wrap">
                                <button onClick={analyzeLastMessageSentiment} className="feature-button bg-blue-600 hover:bg-blue-700" disabled={isLoading || isAnalyzing || isSuggesting || messages.filter(msg => msg.sender === 'user').length === 0}>
                                    âœ¨ Analyze Feelings
                                </button>
                                <button onClick={suggestCopingStrategy} className="feature-button bg-green-600 hover:bg-green-700" disabled={isLoading || isAnalyzing || isSuggesting || messages.filter(msg => msg.sender === 'user').length === 0}>
                                    ðŸŒ± Coping Tips
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const root = createRoot(document.getElementById('root'));
            root.render(<App />);
        });
    </script>
</body>
</html>
