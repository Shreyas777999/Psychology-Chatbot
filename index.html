<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychology Insights Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap');
        :root{--primary-blue:#2c3e50;--light-blue:#ecf0f1;--accent-green:#27ae60;--text-dark:#34495e;--text-light:#fdfefe;--bubble-user:#e8f6f3;--bubble-bot:#dbeaf5;--system-info:#f0f4f7;--border-light:#bdc3c7;--shadow-light:rgba(0,0,0,0.08);--shadow-medium:rgba(0,0,0,0.15);}
        body{font-family:'Poppins',sans-serif;margin:0;padding:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background-color:var(--light-blue);overflow:hidden;color:var(--text-dark);}
        .full-page-container{width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;padding:1.5rem;box-sizing:border-box;}
        .chat-container{background-color:#FFFFFF;border-radius:1.5rem;box-shadow:0 25px 50px var(--shadow-medium);overflow:hidden;display:flex;flex-direction:column;width:100%;height:100%;max-width:960px;max-height:800px;transition:all 0.3s ease-out;}
        @media (max-width:768px){.chat-container{max-width:95vw;max-height:90vh;}}
        .header-bg{background:linear-gradient(135deg,var(--primary-blue) 0%,#3498db 100%);color:var(--text-light);padding:1.5rem 2rem;display:flex;align-items:center;justify-content:center;position:relative;border-top-left-radius:1.5rem;border-top-right-radius:1.5rem;box-shadow:0 2px 8px var(--shadow-light);z-index:10;}
        .header-content{display:flex;align-items:center;gap:1.2rem;animation:fadeInDown 0.8s ease-out;}
        .logo-symbol{height:50px;width:50px;border-radius:50%;box-shadow:0 3px 10px var(--shadow-medium);object-fit:cover;background-color:white;}
        .header-title{font-family:'Lora',serif;font-size:1.8rem;font-weight:700;letter-spacing:-0.03em;text-shadow:1px 1px 3px rgba(0,0,0,0.2);}
        .header-subtitle{font-family:'Poppins',sans-serif;font-size:0.95rem;opacity:0.9;}
        .chat-message-user{background-color:var(--bubble-user);color:var(--text-dark);border-radius:1rem;border-bottom-right-radius:0.5rem;box-shadow:0 1px 3px var(--shadow-light);}
        .chat-message-bot{background-color:var(--bubble-bot);color:var(--text-dark);border-radius:1rem;border-bottom-left-radius:0.5rem;box-shadow:0 1px 3px var(--shadow-light);}
        .input-field{border:1px solid var(--border-light);border-radius:9999px;padding:0.8rem 1.6rem;transition:all 0.2s;box-shadow:inset 0 1px 2px rgba(0,0,0,0.04);font-size:1rem;color:var(--text-dark);}
        .input-field:focus{outline:none;border-color:var(--accent-green);box-shadow:0 0 0 3px rgba(39,174,96,0.2);}
        .send-button{background-color:var(--accent-green);border-radius:9999px;width:60px;height:48px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px var(--shadow-light);transition:all 0.2s;flex-shrink:0;}
        .send-button:hover{background-color:#2ecc71;transform:scale(1.05);box-shadow:0 3px 8px var(--shadow-medium);}
        .feature-button{font-weight:500;padding:0.7rem 1.4rem;border-radius:9999px;box-shadow:0 2px 5px var(--shadow-light);transition:all 0.2s;color:var(--text-light);display:flex;align-items:center;gap:0.6rem;font-size:0.9rem;}
        .feature-button:hover{transform:translateY(-1px);box-shadow:0 3px 7px var(--shadow-medium);}
        .dot-pulse{display:flex;align-items:center;justify-content:center;padding:1rem;}
        .dot-pulse-dot{width:8px;height:8px;background-color:var(--primary-blue);border-radius:50%;margin:0 4px;animation:dotPulse 1.2s infinite ease-in-out;}
        .dot-pulse-dot:nth-child(1){animation-delay:0s;} .dot-pulse-dot:nth-child(2){animation-delay:0.15s;} .dot-pulse-dot:nth-child(3){animation-delay:0.3s;}
        @keyframes dotPulse{0%,100%{transform:scale(0.7);opacity:0.7;}50%{transform:scale(1);opacity:1;}}
        .mode-toggle-bg{background-color:#e0e7ff;padding:0.25rem;border-radius:9999px;display:flex;position:relative;}
        .mode-toggle-button{padding:0.5rem 1rem;font-size:0.875rem;font-weight:500;border-radius:9999px;cursor:pointer;transition:color 0.3s;z-index:1;border:none;background:none;}
        .mode-toggle-button.active{color:var(--primary-blue);}
        .mode-toggle-button.inactive{color:#6b7280;}
        .mode-toggle-glider{position:absolute;top:0.25rem;bottom:0.25rem;width:calc(50% - 0.25rem);background-color:white;border-radius:9999px;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:transform 0.3s ease;}
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const ReactDOM = window.ReactDOM;
        const marked = window.marked;

        const App = () => {
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [responseMode, setResponseMode] = useState('conversational');
            
            const messagesEndRef = useRef(null);

            // ===========================================================================================
            // API KEY & MODEL CONFIGURATION
            //
            // 1. Replace "YOUR_API_KEY_HERE" with your actual Gemini API key.
            // 2. We are using "gemini-1.5-flash-latest" as it is the correct model for the standard free-tier API key.
            //
            // ===========================================================================================
            const API_KEY = "AIzaSyDgBe4ibRkgIyAyTFkZuV8uiPMbIrKwRfU"; // <-- REPLACE WITH YOUR REAL KEY
            const MODEL_NAME = "gemini-1.5-flash-latest";
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);
            
            const callApiWithRetries = async (prompt, retries = 2, delay = 2000) => {
                if (API_KEY === "YOUR_API_KEY_HERE" || !API_KEY) {
                    return "Error: API key is missing. Please replace 'YOUR_API_KEY_HERE' in the index.html file with your actual Gemini API key.";
                }
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(GEMINI_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                        });
                        if (!response.ok && response.status >= 500) { throw new Error(`Server error: ${response.status}`); }
                        if (!response.ok) {
                            const errorResult = await response.json();
                            return `Error: ${errorResult.error?.message || 'API request failed.'}`;
                        }
                        const result = await response.json();
                        if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            console.error("API returned success but no content:", result);
                            return "I received an unusual response from the model, possibly due to a safety filter. Please try rephrasing your query.";
                        }
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed: ${error}.`);
                        if (i === retries - 1) { return "Error: The model seems to be overloaded. Please try again in a moment."; }
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            };

            const handleSendMessage = async (e) => {
                e.preventDefault();
                const userQuery = inputValue.trim();
                if (!userQuery) return;

                setMessages(prev => [...prev, { text: userQuery, sender: 'user' }]);
                setInputValue('');
                setIsLoading(true);

                // --- PROMPT ENGINEERING v5: ROBUST, SINGLE-CALL LOGIC ---

                const academicPrompt = `
                    **Persona:** You are a unique AI, a synthesis of a seasoned clinical psychologist and a university professor of psychology. You are a master of synthesis, capable of drawing connections between disparate fields of psychological thought. Your primary goal is to educate the user by providing a comprehensive, multi-faceted psychoanalytic exploration of their query.

                    **Core Task:** For the user's query, you MUST generate a response that is structured like a detailed, accessible literature review. Your response MUST be comprehensive, detailed, and significantly longer than a typical chatbot answer. It must be well-organized with clear headings for each section.

                    **Mandatory Response Structure (Use Markdown headings for each section):**

                    ### 1. Introduction and Deconstruction
                    Start by briefly reframing the user's query into its core psychological question, demonstrating a deep understanding of the underlying issue.

                    ### 2. Psychodynamic Perspective
                    Analyze the query from a psychodynamic viewpoint. Discuss relevant concepts such as unconscious conflicts, defense mechanisms (you MUST **bold** and define specific mechanisms like projection, displacement, or intellectualization), and the potential influence of early life experiences.

                    ### 3. Cognitive-Behavioral (CBT) Perspective
                    Next, analyze the query from a CBT viewpoint. Identify and discuss the interplay of thoughts, feelings, and behaviors. You MUST identify potential **cognitive distortions** (e.g., catastrophizing, black-and-white thinking), explain what they are, and how they might apply. Discuss the concept of core beliefs.

                    ### 4. Humanistic or Existential Perspective
                    Provide a third perspective from a Humanistic or Existential viewpoint. Discuss concepts like self-actualization, conditions of worth, the search for meaning, or existential anxieties as they relate to the user's query.

                    ### 5. Concluding Synthesis
                    Conclude with a powerful synthesis that integrates the insights from all three perspectives. Explain how these different schools of thought are not mutually exclusive but can provide a more holistic and complete understanding of the user's experience.
                `;

                const conversationalPrompt = `
                    **Persona:** Act as an exceptionally empathetic, warm, and insightful therapist. Your goal is to make the user feel seen, heard, and safe.
                    **Task:** Your response should be a gentle, guided conversation.
                    **Content and Style:**
                    1.  **Deep Validation:** Start by deeply validating the user's feelings. Show that you understand the emotional weight of their situation. For example, instead of "that sounds hard," say "It makes complete sense that you would feel overwhelmed by that; it's a heavy burden to carry."
                    2.  **Simple Concepts:** If you introduce a psychological idea (like an 'inner critic'), explain it simply and immediately tie it back to their experience.
                    3.  **Guiding Questions:** End your response with a gentle, open-ended question that invites introspection, such as "What does that little voice of self-doubt usually tell you in these moments?" or "I'm curious, what do you imagine the best-case scenario could look like, even if it feels far away?"
                `;

                // This unified prompt tells the AI its persona based on the selected mode.
                const masterPrompt = `
                    You are an expert AI assistant specializing in psychology. Your persona and response style are determined by the **RESPONSE MODE** provided.
                    **USER QUERY:** "${userQuery}"
                    **RESPONSE MODE:** "${responseMode}"

                    ---
                    **INSTRUCTIONS FOR YOUR TASK:**
                    Based *only* on the RESPONSE MODE provided above, adopt the corresponding persona and follow its instructions to the letter to answer the USER QUERY. Do not blend the modes. Produce only the final response.

                    ---
                    **MODE-SPECIFIC INSTRUCTIONS LIBRARY:**

                    **If RESPONSE MODE is "conversational":**
                    ${conversationalPrompt}

                    **If RESPONSE MODE is "academic":**
                    ${academicPrompt}
                `;
                
                const botResponse = await callApiWithRetries(masterPrompt);
                
                setMessages(prev => [...prev, { text: botResponse, sender: 'bot' }]);
                
                setIsLoading(false);
            };
            
            const analyzeAndSuggest = async (type) => {
                const lastUserMessage = messages.slice().reverse().find(msg => msg.sender === 'user');
                if (!lastUserMessage) return;
                
                setIsLoading(true);
                let specificPrompt = type === 'analyze'
                    ? `Based on the user's last statement, provide a concise sentiment analysis and psychological insight. Start with "**Emotion & Insight:**".\n**User Statement:** "${lastUserMessage.text}"`
                    : `Based on the user's last statement, suggest a simple, evidence-based coping strategy. Start with "**Coping Tip & Self-Observation:**".\n**User Statement:** "${lastUserMessage.text}"`;
                
                const response = await callApiWithRetries(specificPrompt);
                const prefix = type === 'analyze' ? '✨' : '🌱';
                setMessages(prev => [...prev, { text: `${prefix} ${response}`, sender: 'bot' }]);
                
                setIsLoading(false);
            };

            return (
                <div className="full-page-container">
                    <div className="chat-container">
                        <div className="header-bg">
                            <div className="header-content">
                                <img src="logo.png" alt="Logo" className="logo-symbol"/>
                                <div>
                                    <h1 className="header-title">Psychology Insights</h1>
                                    <p className="header-subtitle">Your AI Companion for Well-being</p>
                                </div>
                            </div>
                        </div>

                        <div className="p-2 bg-slate-100 flex justify-center">
                            <div className="mode-toggle-bg">
                                <div className="mode-toggle-glider" style={{ transform: responseMode === 'conversational' ? 'translateX(0%)' : 'translateX(100%)' }}></div>
                                <button onClick={() => setResponseMode('conversational')} className={`mode-toggle-button ${responseMode === 'conversational' ? 'active' : 'inactive'}`}>Conversational</button>
                                <button onClick={() => setResponseMode('academic')} className={`mode-toggle-button ${responseMode === 'academic' ? 'active' : 'inactive'}`}>Academic</button>
                            </div>
                        </div>

                        <div className="flex-1 p-4 sm:p-6 overflow-y-auto flex flex-col gap-3">
                            {messages.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-full text-gray-500 text-center p-4">
                                    <img src="logo.png" alt="Logo" className="logo-welcome-subtle"/>
                                    <p className="text-xl font-medium font-lora text-gray-700">Explore your mind with AI.</p>
                                    <p className="text-md mt-2 font-poppins text-gray-600">Choose a mode above and ask a question.</p>
                                </div>
                            ) : (
                                messages.map((msg, index) => (
                                    <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[85%] px-4 py-3 text-wrap break-words ${msg.sender === 'user' ? 'chat-message-user' : 'chat-message-bot'}`}>
                                            <div dangerouslySetInnerHTML={{ __html: marked.parse(msg.text) }}></div>
                                        </div>
                                    </div>
                                ))
                            )}
                            {isLoading && (<div className="dot-pulse"><div className="dot-pulse-dot"></div><div className="dot-pulse-dot"></div><div className="dot-pulse-dot"></div></div>)}
                            <div ref={messagesEndRef}></div>
                        </div>
                        
                        <form onSubmit={handleSendMessage} className="p-4 sm:p-5 bg-white border-t border-gray-100 flex items-center gap-3">
                            <div className="flex-1">
                                <input type="text" value={inputValue} onChange={e => setInputValue(e.target.value)} placeholder="Type your thoughts here..." className="input-field w-full" disabled={isLoading}/>
                            </div>
                            <button type="submit" className="send-button text-white" disabled={!inputValue.trim() || isLoading}>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" /></svg>
                            </button>
                        </form>
                        
                        <div className="p-4 sm:p-5 bg-gray-50 border-t border-gray-100 flex justify-center gap-4 flex-wrap">
                            <button onClick={() => analyzeAndSuggest('analyze')} className="feature-button bg-blue-600 hover:bg-blue-700" disabled={isLoading || messages.filter(msg => msg.sender === 'user').length === 0}>
                                ✨ Analyze Feelings
                            </button>
                            <button onClick={() => analyzeAndSuggest('suggest')} className="feature-button bg-green-600 hover:bg-green-700" disabled={isLoading || messages.filter(msg => msg.sender === 'user').length === 0}>
                                🌱 Coping Tips
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
